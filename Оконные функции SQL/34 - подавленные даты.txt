ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸:

ðŸ¤” ÐŸÐ¾Ð´Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð°Ñ‚Ñ‹
Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¼ÐµÑÑÑ†Ð° Ð¿Ð¾ÑÑ‡Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð°Ñ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ð¾Ð¿Ð°Ð´Ð°ÑŽÑ‚ Ð² Ð²ÐµÑ€Ñ…Ð½Ð¸Ðµ 10% Ð¿Ð¾ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑŽ pressure Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ð¼ÐµÑÑÑ†Ð°.

ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð´Ð»Ñ ÑÐ½Ð²Ð°Ñ€Ñ:

select pressure
from weather
where wdate between '2020-01-01' and '2020-01-31'
order by pressure;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pressure â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 99490.0  â”‚
â”‚ 99610.0  â”‚
â”‚ 100130.0 â”‚
â”‚ 100450.0 â”‚
â”‚ 100510.0 â”‚
â”‚ 100640.0 â”‚
â”‚ ...      â”‚
â”‚ 103380.0 â”‚
â”‚ 103400.0 â”‚
â”‚ 103810.0 â”‚
â”‚ 104260.0 â”‚
â”‚ 104280.0 â”‚
â”‚ 104820.0 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Ð—Ð´ÐµÑÑŒ 90 Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð¸Ð»ÑŒ Ñ€Ð°Ð²ÐµÐ½ 103769. Ð’ Ð²ÐµÑ€Ñ…Ð½Ð¸Ðµ 10% Ð¿Ð¾Ð¿Ð°Ð´Ð°ÑŽÑ‚ Ð´Ð°Ñ‚Ñ‹, Ñƒ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ pressure > 103769 â€” Ñ‚Ð°ÐºÐ¸Ñ… Ð´Ð°Ñ‚ Ñ‡ÐµÑ‚Ñ‹Ñ€Ðµ. Ð—Ð½Ð°Ñ‡Ð¸Ñ‚, Ð¸ÑÐºÐ¾Ð¼Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐ½Ð²Ð°Ñ€Ñ â€” 4.

ÐŸÐ¾ÑÑ‡Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ Ð¸ÑÐºÐ¾Ð¼Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð°Ñ‚ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¼ÐµÑÑÑ†Ð° Ð¸ ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¸Ñ… Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ðµ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¾Ð±ÐµÐ» (Ð¾Ñ‚ ÑÐ½Ð²Ð°Ñ€Ñ Ð´Ð¾ Ð¸ÑŽÐ½Ñ). ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€:

4 3 2 1 4 5
Ð”Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð¸Ð»ÐµÐ¹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ percentile_cont().
----------------------------------------------------------------------------------------
ÐœÐ¾Ñ‘ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ:

WITH src AS (
SELECT
    to_char(wdate, 'YYYY-MM') AS wmonth,s
    percentile_cont(0.90) WITHIN GROUP (ORDER BY pressure) AS pressure_90
FROM weather
GROUP BY to_char(wdate, 'YYYY-MM')
ORDER BY wmonth
)
SELECT 
	to_char(wdate, 'YYYY-MM') AS wmonth,
    COUNT(*) FILTER (WHERE pressure >src.pressure_90) AS result
FROM weather 
LEFT JOIN src ON to_char(wdate, 'YYYY-MM')=src.wmonth
GROUP BY 1
ORDER BY 1